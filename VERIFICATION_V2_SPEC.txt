================================================================================
VÉRIFICATION SPÉCIFICATION V2 - ACHATS ET SIMULATION
================================================================================
Date: 17 février 2026

RÉFÉRENCE: 23-examen-final-S3-fev-26-v2.md 2026-02-16

================================================================================
POINT 1: Acheter via les dons en argent
================================================================================
✅ "On peut acheter via les dons en argent les besoins en nature et en 
   matériaux selon les prix unitaires"
   → Implémenté dans AchatsController::besoinsRestants()
   → SQL filtre les besoins Nature et Matériaux (exclut Argent)
   → Utilise les prix unitaires de la table BESOINS

✅ "saisie et liste des achats filtrables par ville à faire"
   → Page achats/besoins_restants.php avec formulaire de filtre
   → SELECT ville avec boutons "Filtrer" et "Réinitialiser"
   → Liste des besoins restants affichée avec bouton "Acheter"

✅ "Il y a un frais d'achat de x% configurable"
   → Table CONFIG avec cle='frais_achat_pourcentage'
   → Config::getFraisAchatPourcentage() retourne la valeur
   → Calcul: montant_total = quantite * prix_unitaire * (1 + frais% / 100)
   → Exemple: achat de 100 avec 10% → 110 Ar

✅ "On utilise la page des besoins restants pour faire les achats"
   → Route: /achats/besoins-restants
   → Vue: achats/besoins_restants.php
   → Modal d'achat avec sélection du don et quantité
   → Calcul automatique avec affichage des frais

✅ "Il y a un message d'erreur si l'achat existe encore dans les dons restants"
   → AchatsController::simuler() vérifie achatModel->achatExiste($id_besoin)
   → Message: "Un achat existe déjà pour ce besoin (simulé ou validé)."
   → Bloque la création de doublons

================================================================================
POINT 2: Page de simulation
================================================================================
✅ "il y a un bouton simuler qui permet de voir le résultat"
   → Page: /simulation (simulation/index.php)
   → Bouton "Simuler" (#run-sim)
   → SimulationController::executeSimulation() stocke en $_SESSION
   → Affiche preview dans tableau #preview-table
   → PAS d'écriture en BD, juste aperçu

✅ "et un bouton validation qui dispatch vraiment les dons"
   → Bouton "Valider les distributions" (#validate-sim)
   → Apparaît après la simulation
   → SimulationController::validerSimulation() commit en BD
   → Crée les entrées dans DISTRIBUTIONS
   → Affichage de l'historique après validation

================================================================================
POINT 3: Page de récapitulation
================================================================================
✅ "Créer une page de récapitulation"
   → Route: /achats/recapitulatif
   → Vue: achats/recapitulatif.php
   → AchatsController::recapitulatif()

✅ "avec un bouton actualiser en Ajax"
   → Bouton "Actualiser" avec fonction actualiserRecap()
   → Fetch vers /achats/recapitulatif avec header X-Requested-With
   → AchatsController détecte AJAX et retourne JSON
   → Mise à jour dynamique sans reload

✅ "qui affiche : les besoins totaux et satisfaits en montant et 
    le montant des besoins restants"
   → 3 cartes statistiques:
     * Besoins totaux (Ar): SUM(b.quantite * b.prix_unitaire)
     * Besoins satisfaits (Ar): distributions + achats validés
     * Besoins restants (Ar): total - satisfaits
   → Barre de progression avec pourcentage
   → Auto-actualisation toutes les 30 secondes

================================================================================
DÉTAILS TECHNIQUES
================================================================================

WORKFLOW ACHATS:
1. /achats/besoins-restants → Liste des besoins avec filtre ville
2. Clic "Acheter" → Modal avec sélection don et quantité
3. POST /achats/simuler → Crée ACHATS avec est_simule=1
4. /achats/simulation → Affiche simulations
5. POST /achats/valider → Set est_valide=1, crée DISTRIBUTIONS

WORKFLOW SIMULATION:
1. /simulation → Page avec boutons
2. POST /api/simulation/execute → Calcul + session (preview)
3. Affichage tableau preview
4. POST /api/simulation/valider → Écriture DISTRIBUTIONS (commit)
5. Historique mis à jour

VÉRIFICATIONS IMPLÉMENTÉES:
- ✅ Montant don suffisant
- ✅ Achat dupliqué bloqué
- ✅ Quantité max respectée
- ✅ Frais calculés automatiquement
- ✅ Filtre par ville fonctionnel
- ✅ AJAX JSON pour récapitulatif

ROUTES DÉFINIES:
- ✅ GET  /achats/besoins-restants
- ✅ POST /achats/simuler
- ✅ GET  /achats/simulation
- ✅ POST /achats/valider
- ✅ POST /achats/annuler
- ✅ GET  /achats/recapitulatif (HTML + JSON via AJAX)
- ✅ GET  /simulation
- ✅ POST /api/simulation/execute
- ✅ POST /api/simulation/valider

================================================================================
CONCLUSION
================================================================================

✅ TOUTES LES SPÉCIFICATIONS V2 SONT COMPLÈTES

Les 3 points principaux de la spécification sont 100% implémentés:
1. ✅ Achats avec dons en argent (filtrable, configurable, sécurisé)
2. ✅ Simulation avec preview/validation séparée
3. ✅ Récapitulatif avec actualisation AJAX

Le projet est prêt pour l'examen final.

================================================================================
